2024-06-11 (TUESDAY): EXPLOITATION OF CVE-2024-4577 VULNERABILITY IN PHP ON WINDOWS

REFERENCES:

- https://www.linkedin.com/posts/unit42_php-timelythreatintel-unit42threatintel-activity-7206454162195111936-G4Gl
- https://x.com/Unit42_Intel/status/1800688488330764515

VULNERABILITY DETAILS:

- Reference: https://nvd.nist.gov/vuln/detail/CVE-2024-4577

- Description: In certain PHP versions when using Apache and PHP-CGI on Windows, if the system is set up to
  use certain code pages, Windows may use "Best-Fit" behavior to replace characters in command line given 
  to Win32 API functions. PHP CGI module may misinterpret those characters as PHP options, which may allow 
  a malicious user to pass options to PHP binary being run, and thus reveal the source code of scripts, 
  run arbitrary PHP code on the server, etc.

- Note: At the time of this post, no CVSS score has yet been assigned to this vulnerability.

DISCOVERY OF VULNERABILITY:

- On 2024-06-06, Orange Tsai (@orange_8361) identified and initially disclosed this vulnerability through X (Twitter).
- Post link: https://x.com/orange_8361/status/1798919363376066781

IMPACT:

- This vulnerability affects the following PHP versions:
  -- 8.1 before 8.1.29
  -- 8.2 before 8.2.20
  -- 8.3 before 8.3.8 
- This vulnerability is applicable when:
  -- Using Apache and PHP-CGI on Windows with character sets (charsets):
     --- 936: simplified Chinese charset, more info at https://en.wikipedia.org/wiki/Code_page_936_(IBM)
     --- 950: traditional Chinese charset, more info at https://en.wikipedia.org/wiki/Code_page_950
     --- 932: Japanese charset, more info at https://en.wikipedia.org/wiki/Code_page_932_(Microsoft_Windows)
   -- Or when using the XAMPP development environment with default configurations on Windows with the same charsets.
     --- More info on XAMPP at https://www.apachefriends.org/

EXPLOITATION MECHANISM: 

- The Windows feature "Best Fit" converts 0xAD to 0x2D.
- Malicious code can be passed through "php://input" and executed using the "auto_prepend_file" option to call "include_path."
- We have also seen the "auto_append_file" option.

EXPLOITATION IN THE WILD:

- Since June 6th, our telemetry has revealed numerous exploitation attempts against this vulnerability.

SOLUTION:

- Upgrade PHP on any vulnerable hosts to the latest version.
- To mitigate this vulnerability, we recommend our customers install the latest content updates for Palo Alto Networks Advanced Threat Protection (ATP).
