import "pe"

rule MAL_EXE_RomCom_First_Stage_Variant_Apr_1 
{
    meta:
        description = "This rule detects the second-stage RomCom malware, which connects to command-and-control (C2) servers and downloads additional payloads."
        author = "PRODAFT Catalyst"
        date = "2025-04-01"
        sharing = "TLP:CLEAR"
        reference = "https://catalyst.prodaft.com/public/report/inside-the-latest-espionage-campaign-of-nebulous-mantis"
        hash1 = "f5f2761278163a1a813356666cb305fe37806f5f633b2a5475997f10d24fb3d4"
        hash2 = "83c29b330e5bf98ce3c6abe4f9df7883f9bc70c125945319ea0218924dea5ccf"
        os = "Windows"
    strings:
        $mz1= {48 83 EC 28 4D 89 CA 4D 29 C2 72 26 4D 85 C0 74 10 49 39 D0 73 09 42 80 3C 01 BF 7F 04 EB 13}
        $mz2 = {4D 85 C9 74 1D 49 39 D1 73 16 42 80 3C 09 BF 7F 11}
        $mz3 = {48 89 54 24 10 55 56 57 48 83 EC 20 48 8D 6A 70 48 8B 4D E8 48 8B 45 F0 48 83 78 08 00 74}
        $mz4 = {41 B8 09 00 00 00 48 89 C1 E8 ?? ?? ?? ?? 90 48 83 C4 68 C3}
        $mz5 = {48 83 EC 68 48 89 D0 48 8B 09 48 8D 51 08 4C 8D 44 24 60 49 89 10 48 8D 15 [4] 48 89 54 24 50 4C 89 44 24 48 }
        $mz6 = {48 8B 51 10 48 8B 41 18 4C 8B 01 49 01 D0 4C 8B 49 08 49 01 C1 48 C1 C2 0D 4C 31 C2 48 C1 C0 10 4C 31 C8 49 C1 C0 20 49 01 D1 49 01 C0 4C 89 01 48 C1 C2 11 4C 31 CA 48 89 51 10 48 C1 C0 15 4C 31 C0 48 89 41 18 49 C1 C1 20 4C 89 49 08 }
    condition:
        uint16(0) == 0x5A4D and for any section in pe.sections : ( section.name == "_RDATA" ) and (filesize > 600KB and filesize < 800KB) and all of them
}

rule MAL_EXE_RomCom_Downloader_Variant_Type1_Apr1
{
    meta:
        description = "This rule detects the second-stage RomCom downloader type 1, which functions as a shellcode loader only."
        author = "PRODAFT Catalyst"
        date = "2025-04-01"
        hash1 = "1b78fb7364e96b1bd9efc679fbf49fb99493ba83f72f4dbc2030c3173c6dae16"
        hash2 = "d99788669cdc088c8935d64961332d5ad5cfee4fd71ff1f2115078f4340a6a99"
        sharing = "TLP:CLEAR"
        reference = "https://catalyst.prodaft.com/public/report/inside-the-latest-espionage-campaign-of-nebulous-mantis"
        os = "Windows"
    strings:
        $seq1 = {8B FF 55 8B EC FF 75 08 68 [2] 41 00 E8 6B 00 00 00 59 59 5D C3}
        $seq2 = {55 8B EC 51 51 53 56 57 64 8B 35 00 00 00 00 89 75 F8 C7 45 FC [2] 40 00 6A 00 FF 75 0C FF 75 FC FF 75 08 FF [2] E0 40 00 90 }
        $seq3 = {83 79 04 00 B8 [2] 40 00 0F 45 41 04 C3}
        $qsort_pattern = {8B 0D [4] 0F AF 0D [4] 89 84 24 [4] 81 C1 [4] 51 6A 01 68 82 02 00 00 68 [4] E8}
    condition:
        uint16(0) == 0x5A4D and (filesize > 100KB and filesize < 130KB) and (pe.number_of_sections == 5) and all of them
}

rule MAL_EXE_RomCom_Downloader_Variant_Type2_Apr1
{
    meta:
        description = "This rule detects the second-stage RomCom downloader type 2, which functions as a shellcode loader only."
        author = "PRODAFT Catalyst"
        date = "2025-04-01"
        hash1 = "2e497ea11e308ba65f5c9da74109ac4ab0edbd13098026ce7c7381a2f70a2915"
        hash2 = "9e4f32a1c50826e39e2b5c1ce9befb76a0f066cbc6764f39ad0aa1276fc8e700"
        sharing = "TLP:CLEAR"
        reference = "https://catalyst.prodaft.com/public/report/inside-the-latest-espionage-campaign-of-nebulous-mantis"
        os = "Windows"
    strings:
        $seq1 = {8B FF 55 8B EC FF 75 08 68 [2] 41 00 E8 6B 00 00 00 59 59 5D C3}
        $seq2 = {55 8B EC 51 51 53 56 57 64 8B 35 00 00 00 00 89 75 F8 C7 45 FC [2] 40 00 6A 00 FF 75 0C FF 75 FC FF 75 08 FF [2] E0 40 00 90 }
        $seq3 = {83 79 04 00 B8 [2] 40 00 0F 45 41 04 C3}
        $qsort_pattern = { 56 FF 15 [4] 68 [4] 6A 01 6A 02 68 [4] E8 [4] FF 35 [4] 6A 01 6A 02 68 [4] E8 }
        $hash_constant = {BE BF 62 7A 56}
    condition:
        uint16(0) == 0x5A4D and (filesize > 100KB and filesize < 130KB) and (pe.number_of_sections == 5) and (all of ($seq*) and ($hash_constant or $qsort_pattern))
}