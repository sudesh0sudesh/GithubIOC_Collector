name: Windows.Detection.CVE_2024_37085
author: Matt Green - @mgreen27
description: |
   This artifact assists scoping for suspicious ESX Admin group activity  
   associated with CVE-2024-37085.
   
   Microsoft researchers discovered CVE-2024-37085 after it was used as a 
   post-compromise attack technique used by a number of ransomware operators. 
   There are 3 methods of exploitation:
   
    - Adding the “ESX Admins” group to the domain and adding a user to it.
    - Renaming any group in the domain to “ESX Admins” and adding a user to the
    group or using an existing group member.
    - Even if the network administrator assigns any other group in the domain to 
    be the management group for the ESXi hypervisor, the full administrative 
    privileges to members of the “ESX Admins” group may still be applied.
    
    
   Features include:   
   
   1. Query the Security event log and scope for events associated with Group 
   creation / modification.
   
   2. Query "ESX Admins" group members to assist scoping for suspicious members.
   NOTE: This component will need to be run on a domain controller. As an alternate method 
   you can try on a domain joined host to execute:   
          - net group /domain "ESX Admins", and     
          - net group /domain "ESXi Admins"     
    

reference:
    - https://www.microsoft.com/en-us/security/blog/2024/07/29/ransomware-operators-exploit-esxi-hypervisor-vulnerability-for-mass-encryption/
    - https://www.rapid7.com/blog/post/2024/07/30/vmware-esxi-cve-2024-37085-targeted-in-ransomware-campaigns/

type: CLIENT

parameters:
  - name: TargetGlob
    default: '%SystemRoot%\\System32\\Winevt\\Logs\\Security.evtx'
  - name: IocRegex
    type: regex
    description: "IOC Regex"
    default: "ESX Admins|ESXi Admins"
  - name: IdRegex
    default: "^(4727|4728|4737)$"
    type: regex    

sources:
  - query: |
      SELECT EventTime, Computer, Channel,Provider, EventID, EventRecordID,
        EventData, Message, OSPath
      FROM Artifact.Windows.EventLogs.EvtxHunter(
                        EvtxGlob=TargetGlob,
                        IocRegex=IocRegex,
                        IdRegex=IdRegex)
  - name: GroupMembership
    description: Query WMI for user GroupMemership. 
    query: |
      SELECT * FROM Artifact.Windows.System.WMIQuery(WMIQuery='SELECT * FROM WIN32_GroupUser')
      WHERE GroupComponent =~ IocRegex
